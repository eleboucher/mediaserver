---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mikrotik-cert-sync
  namespace: system
spec:
  schedule: "0 3 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 86400
      template:
        spec:
          serviceAccountName: mikrotik-cert-sync
          restartPolicy: OnFailure
          containers:
            - name: cert-sync
              image: alpine:3.23
              env:
                - name: ROUTER_HOST
                  value: "192.168.1.2"
                - name: ROUTER_USER
                  value: "cert-sync"
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  apk add -q --no-cache curl openssl jq openssh-client

                  mkdir -p ~/.ssh
                  cat /ssh-key/id_ed25519 > ~/.ssh/id_ed25519
                  echo >> ~/.ssh/id_ed25519
                  chmod 600 ~/.ssh/id_ed25519

                  KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
                  SECRET=$(curl -sS --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
                    -H "Authorization: Bearer $KUBE_TOKEN" \
                    "https://kubernetes.default.svc/api/v1/namespaces/network/secrets/erwanleboucher-dev-tls")

                  echo "$SECRET" | jq -r '.data["tls.crt"]' | base64 -d > /tmp/router.crt
                  echo "$SECRET" | jq -r '.data["tls.key"]' | base64 -d > /tmp/router.key

                  echo "Certificate: $(openssl x509 -in /tmp/router.crt -noout -subject -dates | tr '\n' ' ')"

                  SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR"
                  scp $SSH_OPTS /tmp/router.crt /tmp/router.key "${ROUTER_USER}@${ROUTER_HOST}:/"

                  ssh $SSH_OPTS "${ROUTER_USER}@${ROUTER_HOST}" '
                    /certificate remove [find where name~"router"]
                    /certificate import file-name=router.crt passphrase=""
                    /certificate import file-name=router.key passphrase=""
                    :delay 1s
                    /ip service set www-ssl certificate=router.crt_0
                    /ip service set api-ssl certificate=router.crt_0
                  '
                  echo "Certificate synced to Mikrotik"
              volumeMounts:
                - name: ssh-key
                  mountPath: /ssh-key
                  readOnly: true
              resources:
                requests:
                  cpu: 50m
                  memory: 64Mi
                limits:
                  memory: 128Mi
          volumes:
            - name: ssh-key
              secret:
                secretName: mikrotik-ssh-key
                defaultMode: 0400
