# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/app-template-4.5.0/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
---
# yaml-language-server: $schema=https://k8s-schemas.erwanleboucher.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: longhorn-sync
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: backup
  values:
    controllers:
      main:
        type: cronjob
        cronjob:
          # Run at 5:00 AM every Sunday (After the local Longhorn backup finishes)
          schedule: "0 5 * * 0"
          concurrencyPolicy: Forbid
        pod:
          nodeSelector:
            kubernetes.io/hostname: kharkiv
        containers:
          app:
            image:
              repository: rclone/rclone
              tag: latest
            env:
              - name: RCLONE_CONFIG
                value: "/tmp/rclone.conf"
            command:
              - "/bin/sh"
              - "-c"
            args:
              - |
                echo "ðŸš€ Starting Offsite Sync to Google Drive..."

                cp /config-ro/rclone.conf /tmp/rclone.conf
                chmod 600 /tmp/rclone.conf

                rclone sync /data/backups/longhorn-backups gdrive:longhorn-backups \
                  --transfers 16 \
                  --checkers 16 \
                  --fast-list \
                  --delete-after \
                  --log-level INFO \
                  --stats 1m \
                  --retries 3

                rclone sync /data/backups/homeassistant gdrive:homeassistant-backups \
                  --transfers 16 \
                  --checkers 16 \
                  --fast-list \
                  --delete-after \
                  --log-level INFO \
                  --stats 1m \
                  --retries 3
                echo "âœ… Offsite Sync Complete!"

            resources:
              requests:
                cpu: 200m
                memory: 256Mi
              limits:
                memory: 2Gi

    persistence:
      config:
        type: secret
        name: google-drive-backup
        globalMounts:
          - path: /config-ro

      data:
        enabled: true
        type: persistentVolumeClaim
        existingClaim: shared-media
        globalMounts:
          - path: /data
