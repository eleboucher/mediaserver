---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app vmks
  namespace: monitoring
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: victoria-metrics-k8s-stack
  values:
    nameOverride: *app

    defaultRules:
      rules:
        etcd: false
    kubeControllerManager:
      enabled: false
    kubeScheduler:
      enabled: false
    kubeEtcd:
      enabled: false
    grafana:
      enabled: true
      ingress:
        enabled: true
        annotations:
          traefik.ingress.kubernetes.io/router.entrypoints: websecure
          cert-manager.io/cluster-issuer: "letsencrypt-production"
        hosts:
          - grafana.erwanleboucher.dev
        tls:
          - secretName: grafana-tls
            hosts:
              - grafana.erwanleboucher.dev
      persistence:
        enabled: true
        size: 10Gi
        storageClass: longhorn

    vmagent:
      spec:
        inlineRelabelConfig:
          - action: labeldrop
            regex: "feature_node_kubernetes_io_.*"
