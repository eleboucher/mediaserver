---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app vmks
  namespace: monitoring
spec:
  interval: 1h

  chartRef:
    kind: OCIRepository
    name: victoria-metrics-k8s-stack
  values:
    nameOverride: *app
    annotations:
      reloader.stakater.com/auto: "true"
    defaultRules:
      rules:
        etcd: false
    kubeControllerManager:
      enabled: false
    kubeScheduler:
      enabled: false
    kubeEtcd:
      enabled: false
    grafana:
      enabled: false
      forceDeployDatasource: true
    defaultDashboards:
      enabled: true
      grafanaOperator:
        enabled: true
    defaultDatasources:
      grafanaOperator:
        enabled: true
    alertmanager:
      enabled: true
      spec:
        nodeSelector:
          kubernetes.io/hostname: le-havre
        resources:
          requests:
            cpu: 25m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
        secrets:
          - discord-webhook

      templateFiles:
        discord.tmpl: |-
          {{ define "discord.title" }}
          [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }}
          {{ end }}

          {{ define "discord.message" }}
          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Severity:** {{ .Labels.severity }}
          **Active:** {{ .StartsAt }}

          {{ end }}
          {{ end }}

      config:
        global:
          resolve_timeout: 5m
        route:
          group_by:
            - "alertname"
            - "job"
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 12h
          receiver: "null"
          routes:
            - match_re:
                severity: "warning|critical"
              receiver: "discord"

        receivers:
          - name: "null"
          - name: "discord"
            discord_configs:
              - webhook_url_file: /etc/vm/secrets/discord-webhook/webhook-url
                title: '{{ template "discord.title" . }}'
                message: '{{ template "discord.message" . }}'
    vmagent:
      spec:
        scrapeInterval: 60s
        nodeSelector:
          kubernetes.io/hostname: le-havre
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        inlineRelabelConfig:
          - action: labeldrop
            regex: "feature_node_kubernetes_io_.*"
    vmsingle:
      spec:
        nodeSelector:
          kubernetes.io/hostname: le-havre
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
    vmalert:
      spec:
        nodeSelector:
          kubernetes.io/hostname: le-havre
        resources:
          requests:
            cpu: 25m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
